//@version=6
strategy("BNB PineScript Strategy", overlay=true, initial_capital=100, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============================================================================
// PARAMETRY STRATEGII
// ============================================================================
num_falling = input.int(5, "Liczba spadkowych świec", minval=1, maxval=20)
allow_one_break = input.bool(true, "Pozwól jedno zaburzenie")
take_profit_perc = input.float(4.0, "Take Profit %", minval=0.1, maxval=50.0, step=0.1)
stop_loss_perc = input.float(12.0, "Stop Loss %", minval=0.1, maxval=50.0, step=0.1)
red_candles_to_sell = input.int(6, "Czerwone świece do sprzedaży", minval=1, maxval=20)
loss_lookback_bars = input.int(6, "Blokada po stracie (świece)", minval=1, maxval=50)

// Zakres dat (opcjonalnie)
use_date_range = input.bool(false, "Użyj zakresu dat")
start_date = input.time(timestamp("2023-01-01 00:00"), "Data początkowa")
end_date = input.time(timestamp("2025-12-31 23:59"), "Data końcowa")

// ============================================================================
// FUNKCJA: Sprawdzanie spadkowych świec
// ============================================================================
f_check_falling(num, allow_break) =>
    var int falling_count = 0
    var bool break_used = false
    falling_count := 0
    break_used := false
    
    max_iterations = num + (allow_break ? 1 : 0)
    
    for i = 1 to max_iterations
        mid_curr = (open[i] + close[i]) / 2
        mid_prev = (open[i + 1] + close[i + 1]) / 2
        
        if mid_curr < mid_prev
            falling_count += 1
        else
            if allow_break and not break_used
                break_used := true
            else
                falling_count := 0
                break
    
    falling_count >= num

// ============================================================================
// FUNKCJA: Sprawdzanie niedawnej straty
// ============================================================================
f_recent_loss(lookback) =>
    var bool had_loss = false
    had_loss := false
    
    for i = 1 to lookback
        if strategy.closedtrades > 0
            last_trade_profit = strategy.closedtrades.profit(strategy.closedtrades - 1)
            if last_trade_profit < 0
                had_loss := true
                break
    
    had_loss

// ============================================================================
// WARUNKI KUPNA I SPRZEDAŻY
// ============================================================================

// Zakres dat
in_date_range = use_date_range ? (time >= start_date and time <= end_date) : true

// Sprawdzenie niedawnej straty
recent_loss = f_recent_loss(loss_lookback_bars)

// SYGNAŁ KUPNA
buy_signal = f_check_falling(num_falling, allow_one_break) and in_date_range and not recent_loss

// CENY STOP LOSS I TAKE PROFIT
var float entry_price = na
var float sl_price = na
var float tp_trigger_price = na
var bool tp_tracking = false
var int red_count = 0

if buy_signal and strategy.position_size == 0
    entry_price := close
    sl_price := entry_price * (1 - stop_loss_perc / 100)
    tp_trigger_price := entry_price * (1 + take_profit_perc / 100)
    tp_tracking := false
    red_count := 0
    strategy.entry("Long", strategy.long)

// AKTYWACJA TAKE PROFIT
if strategy.position_size > 0 and not tp_tracking and high >= tp_trigger_price
    tp_tracking := true
    red_count := 0

// LICZENIE CZERWONYCH ŚWIEC PO AKTYWACJI TP
if strategy.position_size > 0 and tp_tracking
    if close < open
        red_count += 1
    else
        red_count := 0
    
    // Sprzedaż po N czerwonych świecach
    if red_count >= red_candles_to_sell
        strategy.close("Long", comment="TAKE_PROFIT")
        tp_tracking := false
        red_count := 0

// STOP LOSS (sztywny)
if strategy.position_size > 0
    strategy.exit("SL", from_entry="Long", stop=sl_price)

// ============================================================================
// WIZUALIZACJA
// ============================================================================

// Oznaczenia na wykresie
plotshape(buy_signal and strategy.position_size == 0, "Sygnał Kupna", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(strategy.position_size > 0 and tp_tracking, "TP Aktywny", shape.circle, location.abovebar, color.yellow, size=size.tiny)

// Linie SL i TP
plot(strategy.position_size > 0 ? sl_price : na, "Stop Loss", color.red, linewidth=1, style=plot.style_linebr)
plot(strategy.position_size > 0 ? tp_trigger_price : na, "Take Profit Trigger", color.green, linewidth=1, style=plot.style_linebr)

// Tło gdy TP aktywny
bgcolor(tp_tracking ? color.new(color.yellow, 90) : na, title="TP Tracking")

// ============================================================================
// INFORMACJE
// ============================================================================

// Tabela z parametrami (opcjonalnie)
if barstate.islast
    var table info_table = table.new(position.top_right, 2, 8, border_width=1)
    
    table.cell(info_table, 0, 0, "Parametr", bgcolor=color.gray, text_color=color.white)
    table.cell(info_table, 1, 0, "Wartość", bgcolor=color.gray, text_color=color.white)
    
    table.cell(info_table, 0, 1, "Spadkowe świece")
    table.cell(info_table, 1, 1, str.tostring(num_falling))
    
    table.cell(info_table, 0, 2, "Zaburzenie")
    table.cell(info_table, 1, 2, allow_one_break ? "TAK" : "NIE")
    
    table.cell(info_table, 0, 3, "Take Profit")
    table.cell(info_table, 1, 3, str.tostring(take_profit_perc) + "%")
    
    table.cell(info_table, 0, 4, "Stop Loss")
    table.cell(info_table, 1, 4, str.tostring(stop_loss_perc) + "%")
    
    table.cell(info_table, 0, 5, "Czerwone świece")
    table.cell(info_table, 1, 5, str.tostring(red_candles_to_sell))
    
    table.cell(info_table, 0, 6, "Blokada po stracie")
    table.cell(info_table, 1, 6, str.tostring(loss_lookback_bars))
    
    table.cell(info_table, 0, 7, "TP Tracking")
    table.cell(info_table, 1, 7, tp_tracking ? "AKTYWNY" : "NIE", 
               bgcolor=tp_tracking ? color.new(color.yellow, 70) : na)
